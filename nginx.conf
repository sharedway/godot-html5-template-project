user  nginx;
worker_processes  auto;

events {
    worker_connections  1024;
}

http {
    # Basic hardening and sane defaults
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    tcp_nopush    on;
    tcp_nodelay   on;
    keepalive_timeout  65;

    # Ensure WASM gets the right MIME type on older images (belt & suspenders)
    types {
        application/wasm wasm;
    }

    # Enable gzip for text assets (Godot’s index.html and .js benefit)
    gzip on;
    gzip_comp_level 5;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/javascript application/json application/wasm application/xml image/svg+xml;

    # If you ship precompressed assets, these serve them automatically
    # (e.g., Godot can export .gz/.br files for .js/.wasm)
    # NOTE: You still keep gzip on for non-precompressed text assets.
    gzip_static on;

    # Optional: If you also provide Brotli (.br) files, use the nginx-brotli module image instead.
    # For the stock image, we can still map .br manually via try_files below per file if needed.

    server {
        listen       80;
        server_name  _;

        root /usr/share/nginx/html;

        # --- Caching rules ---
        # Cache “immutable” build artifacts aggressively.
        # Adjust the pattern to your build artifacts if you fingerprint them.


        location ~* \.(?:js|mjs|wasm|pck|png|jpg|jpeg|webp|gif|mp3|ogg|wav|mp4|webm|woff2?)$ {
            add_header Cache-Control "public, max-age=31536000, immutable";
            try_files $uri $uri.gz $uri.br =404;
        }

        # HTML should NOT be cached, so users always get the latest loader
        location = /index.html {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
            try_files /index.html =404;
        }

        # Default: serve files or 404
        location / {
            # If you prefer SPA-style fallback, swap to: try_files $uri /index.html;
            try_files $uri /index.html;
        }

        # --- Optional security headers ---
        # If your Godot export uses threads (SharedArrayBuffer), you MUST enable COOP/COEP:
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;

        # If loading assets from other origins, you may also need CORS:
        # add_header Access-Control-Allow-Origin "*" always;
        # add_header Cross-Origin-Resource-Policy "cross-origin" always;
    }
}
